import{b as c,j as e,I as K,a7 as Q,A as U,w as R,u as V,x as _,ag as F,v as E,t as k,Q as M,C as q,M as J}from"./index-Bpu-ZP8V.js";import{M as W,D as X,a as Y}from"./index-DOw9Vza5.js";import{F as Z,B as L}from"./index-BwNXfVh5.js";import{B as D}from"./index-B5psXmxu.js";import{C as ee}from"./index-CdXBdv_H.js";import{S as H}from"./index-DwaAnJwn.js";import{u as te}from"./useStoreManagement-AgWGUTwC.js";import{S as ae}from"./index-BAGGOChB.js";import"./PhoneIcon-BpksOs-8.js";const ne=48,se=({options:N})=>{const[u,b]=c.useState(null),n=!!u,x=s=>{b(s.currentTarget)},w=()=>{b(null)};return e.jsxs("div",{children:[e.jsx(K,{"aria-label":"more",id:"long-button","aria-controls":n?"long-menu":void 0,"aria-expanded":n?"true":void 0,"aria-haspopup":"true",onClick:x,children:e.jsx(W,{})}),e.jsx(Q,{id:"long-menu",MenuListProps:{"aria-labelledby":"long-button"},anchorEl:u,open:n,onClose:w,PaperProps:{style:{maxHeight:ne*4.5,width:"20ch"}},children:N.map(s=>e.jsx(U,{onClick:()=>{s.onPress(),w()},children:s==null?void 0:s.title},s==null?void 0:s.id))})]})},G=()=>{const{user:N,accessToken:u,isAuthorizedForAdmin:b,isAuthorizedForManager:n}=R(),{users:x}=V(o=>o.users),[w,s]=c.useState(0),[C,y]=c.useState(!1),p=_(),r=async o=>{var t,g,i,a;const{addLoadingEffect:h,overrideCache:f}=o||{};if((x==null?void 0:x.length)==0||f==!0)try{h&&y(!0);const m=b?`${E}/tenant/users`:`${E}/tenant/staffs/${(t=N==null?void 0:N.store)==null?void 0:t.id}`,l=await k.get(`${m}`,{headers:{Authorization:`Bearer ${u}`}});((g=l==null?void 0:l.data)==null?void 0:g.success)==!0&&(p(F((i=l==null?void 0:l.data)==null?void 0:i.data)),s((a=l==null?void 0:l.data)==null?void 0:a._totalPage))}catch(m){console.log("GET USER ERROR",m)}finally{h&&y(!1)}else return Promise.resolve()};return{getAllUser:r,handleDeactivateUser:async o=>{var h;try{const f={isActive:!1,store:8},t=await k.put(`${E}/tenant/users/${o}`,f,{headers:{Authorization:`Bearer ${u}`}});((h=t==null?void 0:t.data)==null?void 0:h.success)==!0&&(M.success("Vô hiệu hóa tài khoản thành công"),await r({addLoadingEffect:!0}))}catch{console.log("error")}},handleActivateUser:async o=>{var h;try{const f={isActive:!0,store:8},t=await k.put(`${E}/tenant/users/${o}`,f,{headers:{Authorization:`Bearer ${u}`}});((h=t==null?void 0:t.data)==null?void 0:h.success)==!0&&(M.success("Kích hoạt tài khoản thành công"),r({addLoadingEffect:!1}))}catch{console.log("error")}},updateUser:async(o,h)=>await k.put(`${E}/tenant/users/${o==null?void 0:o.id}`,h,{headers:{Authorization:`Bearer ${u}`}}),createUser:async(o,h)=>await k.post(`${E}/tenant/create-${o==null?void 0:o.id}`,h,{headers:{Authorization:`Bearer ${u}`}}),setUsers:F,totalPage:w,loading:C,users:x}},O=({onClose:N,isOpen:u,onSuccess:b,currentUser:n})=>{const[x,w]=c.useState({username:"",firstName:"",lastName:"",phoneNumber:"",email:"",password:""}),[s,C]=c.useState(null),[y,p]=c.useState(!1),{user:r,isAuthorizedForAdmin:A}=R(),{getAllStores:T,listStore:S,loading:v}=te(),{updateUser:o,createUser:h}=G(),f=c.useMemo(()=>(r==null?void 0:r.role)==="admin"?[{id:"staff",name:"Nhân viên"},{id:"manager",name:"Cửa hàng trưởng"}]:[{id:"staff",name:"Nhân viên"}],[r==null?void 0:r.role]),[t,g]=c.useState(f[0]),i=async a=>{var m,l,d,z,P,B,I;try{p(!0);const j=n?{username:a.username,firstName:a.firstName,lastName:a.lastName,phoneNumber:a.phoneNumber,email:a.email,store:A?s==null?void 0:s.id:(m=r==null?void 0:r.store)==null?void 0:m.id,role:t==null?void 0:t.id}:{username:a.username,role:t==null?void 0:t.id,firstName:a.firstName,lastName:a.lastName,phoneNumber:a.phoneNumber,email:a.email,password:a==null?void 0:a.password,store:A?s==null?void 0:s.id:(l=r==null?void 0:r.store)==null?void 0:l.id},$=n?await o(n,j):await h(t,j);(d=$==null?void 0:$.data)!=null&&d.success&&(b&&(b==null||b()),N(),p(!1),n?M.success("Cập nhật người dùng thành công"):M.success("Tạo người dùng thành công"))}catch(j){console.log("ERROR",j),n?M.error(((P=(z=j==null?void 0:j.response)==null?void 0:z.data)==null?void 0:P.message)||"Cập nhật người dùng thất bại"):M.error(((I=(B=j==null?void 0:j.response)==null?void 0:B.data)==null?void 0:I.message)||"Tạo người dùng thất bại")}finally{p(!1)}};return c.useEffect(()=>{T()}),c.useEffect(()=>{n&&S.length>0&&(w(n),C(S.find(a=>{var m;return(a==null?void 0:a.id)===((m=n==null?void 0:n.store)==null?void 0:m.id)})),g(f.find(a=>a.id===(n==null?void 0:n.role))))},[S,n,f]),e.jsx(e.Fragment,{children:u?e.jsx(ee,{title:n?"Cập nhật người dùng":"Tạo người dùng",open:u,onClose:N,children:e.jsx(e.Fragment,{children:v?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(q,{size:40})}):e.jsx(Z,{initialValues:x,onSubmit:i,enableReinitialize:!0,children:({handleSubmit:a,values:m,setFieldValue:l})=>e.jsxs("div",{className:"flex flex-col gap-y-10",children:[e.jsxs("div",{className:"flex flex-col gap-y-5",children:[e.jsx(L,{type:"text",name:"username",value:m.username,label:"Username",placeholder:"Nhập username người dùng",onChange:d=>l("username",d.target.value)}),e.jsxs("div",{className:"grid grid-cols-1 gap-5 tablet:grid-cols-2",children:[e.jsx(L,{type:"text",name:"firstName",value:m.firstName,label:"Họ người dùng",placeholder:"Nhập họ người dùng",onChange:d=>l("firstName",d.target.value)}),e.jsx(L,{type:"text",name:"lastName",value:m.lastName,label:"Tên người dùng",placeholder:"Tên họ người dùng",onChange:d=>l("lastName",d.target.value)})]}),e.jsx(L,{type:"phoneNumber",name:"phoneNumber",value:m.phoneNumber,label:"Số điện thoại",placeholder:"Nhập số điện thoại người dùng",onChange:d=>l("phoneNumber",d.target.value)}),e.jsx(L,{type:"email",name:"email",value:m.email,label:"Email",placeholder:"Nhập email người dùng",onChange:d=>l("email",d.target.value)}),n?null:e.jsx(L,{type:"password",name:"password",mode:"password",value:m.password,label:"Mật khẩu",placeholder:"Nhập mật khẩu người dùng",onChange:d=>l("password",d.target.value)}),e.jsx(H,{options:f,name:"role",placeholder:"Chọn vai trò cho user",label:"Chọn vai trò",optionSelected:t,keyLabel:"name",keyValue:"id",onSelect:d=>g(d)}),A&&e.jsx(H,{options:S,name:"store",placeholder:"Chọn cửa hàng cho user",label:"Chọn cửa hàng",optionSelected:s,keyLabel:"name",keyValue:"id",onSelect:d=>C(d)})]}),e.jsxs("div",{className:"flex flex-row-reverse items-center gap-x-4",children:[e.jsx(D,{type:"button",title:"Xác nhận",variant:"primary",isLoading:y,onClick:a}),e.jsx(D,{variant:"secondary",onClick:N,title:"Đóng"})]})]})})})}):null})},fe=()=>{const[N,u]=c.useState(!1),[b,n]=c.useState([]),[x,w]=c.useState(!1),[s,C]=c.useState(null),{users:y,getAllUser:p,loading:r,handleDeactivateUser:A,handleActivateUser:T}=G(),[S,v]=c.useState([]),{isAuthorizedForManager:o}=R(),h=[{field:"actions",headerName:"Hành động",type:"string",width:100,renderCell:t=>{var g;if(o){const i=[(g=t==null?void 0:t.row)!=null&&g.isActive?{id:"deactivate",title:"Khóa",onPress:()=>{var a;return A((a=t.row)==null?void 0:a.id)},onActionSuccess:()=>p({addLoadingEffect:!1})}:{id:"activate",title:"Cập nhật",onPress:()=>{var a;return T((a=t.row)==null?void 0:a.id)},onActionSuccess:()=>p({addLoadingEffect:!1})},{id:"update-account",title:"Cập nhật",onPress:()=>{w(!0),C(t.row)},onActionSuccess:()=>p({addLoadingEffect:!1})}];return e.jsx(se,{options:i})}else return e.jsx(e.Fragment,{})}},{field:"id",headerName:"ID",width:70,renderHeader:()=>e.jsx("div",{className:"font-bold text-gray-800",children:"ID"})},{field:"username",headerName:"Tên người dùng",width:250,renderHeader:()=>e.jsx("div",{className:"font-bold text-gray-800",children:"Tên người dùng"}),renderCell:t=>{var g,i;return e.jsxs("p",{className:"text-sm font-semibold text-gray-600",children:[(g=t==null?void 0:t.row)==null?void 0:g.firstName," ",(i=t==null?void 0:t.row)==null?void 0:i.lastName]})}},{field:"store",headerName:"Cửa hàng",width:250,renderCell:t=>{var g,i;return e.jsx("p",{className:"font-regular text-sm text-gray-600",children:((i=(g=t==null?void 0:t.row)==null?void 0:g.store)==null?void 0:i.name)||"Không có"})}},{field:"role",headerName:"Vai trò",width:200,renderCell:t=>{switch(t.value){case"admin":return e.jsx("p",{className:"rounded-full bg-yellow-50 px-2 py-1 text-xs font-bold text-yellow-800",children:"Quản trị viên"});case"manager":return e.jsx("p",{className:"rounded-full bg-purple-50 px-2 py-1 text-xs font-bold text-purple-800",children:"Cửa hàng trưởng"});case"staff":return e.jsx("p",{className:"rounded-full bg-blue-50 px-2 py-1 text-xs font-bold text-blue-800",children:"Nhân viên"});default:return e.jsx("p",{className:"rounded-full bg-green-50 px-2 py-1 text-xs font-bold text-green-800",children:"Người dùng"})}}},{field:"email",headerName:"Email",width:250},{field:"phoneNumber",headerName:"Số điện thoại",width:200}],f=t=>{if((t==null?void 0:t.length)>0){const g=y.filter(i=>i!=null&&i.username.toLowerCase().includes(t.toLowerCase())?!0:`${i==null?void 0:i.firstName} ${i==null?void 0:i.lastName}`.toLowerCase().includes(t.toLowerCase()));v([...g])}else v(y)};return c.useEffect(()=>{p({addLoadingEffect:!0,overrideCache:!1})},[]),c.useEffect(()=>{v(y)},[y]),e.jsxs(e.Fragment,{children:[e.jsx(J,{title:"Quản lý người dùng",content:e.jsxs("div",{className:"flex w-full flex-col gap-y-5 rounded-xl bg-white",children:[e.jsxs("div",{className:"flex flex-row items-center justify-between",children:[e.jsx(ae,{name:"search-user",label:"Tìm kiếm người dùng",mode:"text",className:"max-w-[400px] rounded-xl border border-gray-300 px-4 py-2 text-sm",placeholder:"John Doe",autoComplete:"off",onChangeValue:t=>f(t)}),e.jsx("div",{children:o&&e.jsx(D,{title:"Tạo người dùng",onClick:()=>{C(null),w(!0)}})})]}),e.jsx("div",{className:"h-[750px] w-full",children:e.jsx(X,{disableColumnFilter:!1,className:"shadow-xl",sx:{borderRadius:"8px",overflow:"hidden"},scrollbarSize:1,rows:S,getEstimatedRowHeight:()=>42,components:{LoadingOverlay:Y},loading:r,paginationMode:"client",hideFooterSelectedRowCount:!1,columns:h,disableSelectionOnClick:!0,pageSize:12,rowHeight:50,onSelectionModelChange:t=>{u(!N),n(t)},selectionModel:b,checkboxSelection:!1})})]})}),x&&e.jsx(e.Fragment,{children:s?e.jsx(O,{currentUser:s,isOpen:x,onClose:()=>w(!1),onSuccess:()=>p({addLoadingEffect:!1,overrideCache:!0})}):e.jsx(O,{onSuccess:()=>p({addLoadingEffect:!1,overrideCache:!0}),isOpen:x,onClose:()=>w(!1)})})]})};export{fe as default};
